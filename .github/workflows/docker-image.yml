name: Build and push changed Dockerfiles

on:
  push:
    branches:
      - master

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Sjekk ut koden
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Viktig for git diff

      - name: Finn endrede Dockerfiles
        id: find
        run: |
          FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep 'Dockerfile$' || true)

          if [ -z "$FILES" ]; then
            echo "Ingen endrede Dockerfiles i denne pushen."
            echo "files=" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Fant følgende endrede Dockerfiles:"
          echo "$FILES"

          FILES_ESCAPED=$(echo "$FILES" | tr '\n' ' ')
          echo "files=$FILES_ESCAPED" >> $GITHUB_OUTPUT

      - name: Logg inn på Docker Hub
        if: ${{ steps.find.outputs.files != '' }}
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Bygg og push images
        if: ${{ steps.find.outputs.files != '' }}
        run: |
          for file in ${{ steps.find.outputs.files }}; do
            dir=$(dirname "$file")
            image_name=$(basename "$dir")

            echo "Bygger og pusher $image_name fra $file..."
            docker build "$dir" -t ${{ secrets.DOCKERHUB_USERNAME }}/$image_name:latest
            docker push ${{ secrets.DOCKERHUB_USERNAME }}/$image_name:latest
          done
