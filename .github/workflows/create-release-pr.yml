name: Create Release PR (select images)

on:
  workflow_dispatch:
    inputs:
      dirs:
        description: 'Comma-separated app dirs to promote (e.g. salamicontainers/salami/valkey/8,salamicontainers/salami/other/1)'
        required: true

permissions:
  contents: write
  pull-requests: write

jobs:
  plan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dev
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      - name: Ensure jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Build release plan
        id: plan
        shell: bash
        run: |
          set -euo pipefail
          IFS=, read -r -a ARR <<<"${{ github.event.inputs.dirs }}"
          includes="[]"
          for d in "${ARR[@]}"; do
            d="${d//[$'\n\r\t ']/}"
            [ -n "$d" ] || continue
            [ -f "$d/Dockerfile" ] || { echo "Skip: $d (no Dockerfile)"; continue; }
            [ -f "$d/VERSION" ] || { echo "Skip: $d (no VERSION)"; continue; }
            ver="$(tr -d '\n\r\t ' < "$d/VERSION")"
            major="$(basename "$d")"
            app="$(basename "$(dirname "$d")")"
            image="ghcr.io/${{ github.repository_owner }}/salami-${app}-${major}"
            tags="${image}:${ver},${image}:latest"
            includes="$(jq -c --arg dir "$d" --arg img "$image" --arg ver "$ver" --arg tags "$tags" \
              '. + [{dir:$dir,image:$img,version:$ver,tags:$tags}]' <<<"$includes")"
          done
          mkdir -p .github/releases
          jq -c '{include: .}' <<<"$includes" > .github/releases/release-plan.json
          echo "plan=$(cat .github/releases/release-plan.json)" >> "$GITHUB_OUTPUT"

      - name: Create PR dev -> main with release plan
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ github.token }}
          base: main
          branch: "promote/${{ github.run_id }}"
          title: "Promote selected images to main"
          commit-message: "chore(release): promote selected images"
          labels: promote
          body: |
            This PR promotes the following images:
            ```
            ${{ steps.plan.outputs.plan }}
            ```